name: test-binaries-qemu

on:
  workflow_run:
    workflows: [build]
    types:
      - completed

jobs:
  test-x86_64:
    runs-on: ubuntu-22.04
    steps:
      # Debug step to list artifacts for the run
      - name: List available artifacts
        run: |
          echo "Available artifacts:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" | jq '.artifacts[] | .name'
      - name: Download coveralls-linux-x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: coveralls-linux-binaries
          path: ./artifacts
      - name: Verify binary
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          chmod +x ./artifacts/coveralls-linux-x86_64
          ./artifacts/coveralls-linux-x86_64 --version
          ./artifacts/coveralls-linux-x86_64 report --measure --base-path src/coverage_reporter/

  test-aarch64:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [aarch64]
    steps:
      # Debug step to list artifacts for the run
      - name: List available artifacts
        run: |
          echo "Available artifacts:"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" | jq '.artifacts[] | .name'
      - name: Set up QEMU for aarch64 emulation
        uses: docker/setup-qemu-action@v3
      - name: Download coveralls-linux-aarch64 binary
        uses: actions/download-artifact@v4
        with:
          name: coveralls-linux-binaries
          path: ./artifacts
      - name: Verify binary
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        run: |
          chmod +x ./artifacts/coveralls-linux-aarch64
          ./artifacts/coveralls-linux-aarch64 --version 
          ./artifacts/coveralls-linux-aarch64 report --measure --base-path src/coverage_reporter/
